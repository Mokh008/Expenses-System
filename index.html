<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تقديم مصروفات الإعاشة</title>

<style>
:root{
  --primary:#0F172A;
  --accent:#22C55E;
  --bg:#F8FAFC;
  --text:#020617;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:480px;
  margin:60px auto;
  background:#fff;
  border-radius:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.1);
  padding:30px;
}
h1{text-align:center;color:var(--primary)}
.field{margin-bottom:20px}
label{font-weight:600;display:block;margin-bottom:6px}
input,select,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #CBD5E1;
}
button{
  background:var(--primary);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.days-box{margin-top:20px;display:none}
.day{
  border:1px solid #E5E7EB;
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
  display:flex;
  gap:10px;
}
.summary{
  background:#F1F5F9;
  padding:15px;
  border-radius:10px;
  margin-top:20px;
  display:none;
}
</style>
</head>

<body>

<div class="container">
<h1>تقديم مصروفات الإعاشة</h1>

<div class="field">
<label>رقم المهندس</label>
<input type="number" id="empId">
</div>

<div class="field">
<label>الشهر</label>
<select id="month">
<option value="">اختر</option>
<option value="1">يناير</option>
<option value="2">فبراير</option>
<option value="3">مارس</option>
<option value="4">أبريل</option>
<option value="5">مايو</option>
<option value="6">يونيو</option>
<option value="7">يوليو</option>
<option value="8">أغسطس</option>
<option value="9">سبتمبر</option>
<option value="10">أكتوبر</option>
<option value="11">نوفمبر</option>
<option value="12">ديسمبر</option>
</select>
</div>

<button onclick="loadAttendance()">تحميل أيام الحضور</button>

<div class="days-box" id="daysBox"></div>

<div class="summary" id="summary">
<div>عدد الأيام: <strong id="daysCount">0</strong></div>
<div>الإجمالي: <strong id="total">0</strong> جنيه</div>
</div>

<button id="submitBtn" style="display:none" onclick="submitExpenses()">
إنشاء ملف المصروفات
</button>
</div>

<script>
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbwrlOdHOznZ-Ls9Fxlp0pQ4MlooXA_zukXlvGwtTHxWbQUbG1VramnPuJhmZAKccS5K/exec";

function loadAttendance(){
  const id = empId.value;
  const m = month.value;
  if(!id||!m){alert("أدخل البيانات");return;}

  daysBox.style.display="block";
  daysBox.innerHTML="جاري التحميل...";

  fetch(`${WEB_APP_URL}?action=getDays&id=${id}&month=${m}`)
  .then(r=>r.json())
  .then(data=>{
    daysBox.innerHTML="";
    data.forEach(d=>{
      daysBox.innerHTML+=`
        <div class="day">
        <input type="checkbox" data-date="${d.date}" data-day="${d.day}" onchange="calc()">
        ${d.date} (${d.day})
        </div>`;
    });
  });
}

function calc(){
  const checked=[...document.querySelectorAll(".day input:checked")];
  daysCount.innerText=checked.length;
  total.innerText=checked.length*200;
  summary.style.display="block";
  submitBtn.style.display="block";
}

function groupByWeekDay(){
  const checked=[...document.querySelectorAll(".day input:checked")];
  const map={};

  checked.forEach(c=>{
    const d=new Date(c.dataset.date);
    const dayName=c.dataset.day;
    if(!map[dayName]) map[dayName]=[];
    map[dayName].push(d);
  });

  const result={};
  for(let k in map){
    if(map[k].length===1){
      result[k]=map[k][0].getDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][map[k][0].getMonth()];
    }else{
      result[k]=map[k].map(x=>x.getDate()+"/"+(x.getMonth()+1)).join(" & ");
    }
  }
  return result;
}

function submitExpenses(){
  const payload={
    action:"submit",
    id:empId.value,
    month:month.value,
    days:+daysCount.innerText,
    total:+total.innerText,
    breakdown:groupByWeekDay()
  };

  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  }).then(()=>alert("تم إنشاء ملف المصروفات"));
}
</script>

</body>
</html>
