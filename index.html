<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØªÙ‚Ø¯ÙŠÙ… Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¹Ø§Ø´Ø©</title>

<style>
:root{
  --primary:#0F172A;
  --bg:#F8FAFC;
  --text:#020617;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Tahoma,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.container{
  max-width:480px;
  margin:60px auto;
  background:#fff;
  border-radius:16px;
  box-shadow:0 20px 40px rgba(0,0,0,.1);
  padding:30px;
}
h1{text-align:center;color:var(--primary)}
.field{margin-bottom:20px}
label{font-weight:600;display:block;margin-bottom:6px}
input,select,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #CBD5E1;
  font-size:15px;
}
button{
  background:var(--primary);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}
.days-box{margin-top:20px;display:none}
.day{
  border:1px solid #E5E7EB;
  border-radius:8px;
  padding:10px;
  margin-bottom:8px;
  display:flex;
  gap:10px;
}
.summary{
  background:#F1F5F9;
  padding:15px;
  border-radius:10px;
  margin-top:20px;
  display:none;
}
.loader{
  display:none;
  text-align:center;
  margin-top:15px;
  font-weight:600;
}
.success{
  display:none;
  background:#DCFCE7;
  color:#166534;
  padding:12px;
  border-radius:10px;
  margin-top:15px;
  text-align:center;
  font-weight:600;
}
.footer{
  text-align:center;
  margin-top:25px;
  font-size:13px;
  color:#64748B;
}
</style>
</head>

<body>

<div class="container">
<h1>ØªÙ‚Ø¯ÙŠÙ… Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¹Ø§Ø´Ø©</h1>

<div class="field">
<label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ (ID)</label>
<input type="number" id="empId" placeholder="Ù…Ø«Ø§Ù„: 1001730">
</div>

<div class="field">
<label>Ø§Ù„Ø´Ù‡Ø±</label>
<select id="month">
<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
<option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
<option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
<option value="3">Ù…Ø§Ø±Ø³</option>
<option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
<option value="5">Ù…Ø§ÙŠÙˆ</option>
<option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
<option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
<option value="8">Ø£ØºØ³Ø·Ø³</option>
<option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
<option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
<option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
<option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
</select>
</div>

<button onclick="loadAttendance()">ØªØ­Ù…ÙŠÙ„ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</button>

<div class="days-box" id="daysBox"></div>

<div class="summary" id="summary">
<div>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: <strong id="daysCount">0</strong></div>
<div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¹Ø§Ø´Ø©: <strong id="total">0</strong> Ø¬Ù†ÙŠÙ‡</div>
</div>

<button id="submitBtn" style="display:none" onclick="submitExpenses()">
Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
</button>

<div class="loader" id="loader">
â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...
</div>

<div class="success" id="successBox"></div>

<div class="footer">
Ù†Ø¸Ø§Ù… Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¹Ø§Ø´Ø©
</div>
</div>

<script>
// ğŸ”— BACKEND URL
const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbyCoMsqb22_D1fOLo8ZC7GpzJP8ax1Ldtv2ty6DHAKWHDX90ua5EQzBISgZh8t9bmLc/exec";

// ØªØ­Ù…ÙŠÙ„ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±
function loadAttendance(){
  const id = empId.value;
  const m  = month.value;
  if(!id || !m){
    alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ ÙˆØ§Ù„Ø´Ù‡Ø±");
    return;
  }

  daysBox.style.display="block";
  daysBox.innerHTML="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  fetch(`${WEB_APP_URL}?action=getDays&id=${id}&month=${m}`)
  .then(r=>r.json())
  .then(data=>{
    daysBox.innerHTML="";

    if(!data.length){
      daysBox.innerHTML="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±";
      return;
    }

    data.forEach(d=>{
      daysBox.innerHTML+=`
        <div class="day">
          <input type="checkbox"
                 data-date="${d.date}"
                 data-day="${d.day}"
                 onchange="calc()">
          ${d.date} (${d.day})
        </div>`;
    });
  })
  .catch(()=>{
    daysBox.innerHTML="Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
  });
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
function calc(){
  const checked =
    document.querySelectorAll(".day input:checked").length;

  daysCount.innerText = checked;
  total.innerText = checked * 200;

  summary.style.display="block";
  submitBtn.style.display="block";
}

// ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…
function groupByWeekDay(){
  const checked =
    document.querySelectorAll(".day input:checked");
  const result={};

  checked.forEach(c=>{
    const day = c.dataset.day;
    if(!result[day]) result[day]=[];
    result[day].push(c.dataset.date);
  });

  const final={};
  for(let k in result){
    final[k]=result[k].join(" & ");
  }
  return final;
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function submitExpenses(){

  if(+daysCount.innerText === 0){
    alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
    return;
  }

  submitBtn.disabled = true;
  loader.style.display="block";
  successBox.style.display="none";

  const payload={
    id:empId.value,
    month:month.value,
    days:+daysCount.innerText,
    total:+total.innerText,
    breakdown:groupByWeekDay()
  };

  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    loader.style.display="none";
    submitBtn.disabled = false;

    if(res.pdfUrl){
      successBox.style.display="block";
      successBox.innerHTML = `
        âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­<br><br>
        <a href="${res.pdfUrl}" target="_blank"
           style="
             display:inline-block;
             background:#0F172A;
             color:#fff;
             padding:10px 20px;
             border-radius:10px;
             text-decoration:none;
             font-weight:600;
           ">
          ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª (PDF)
        </a>
      `;
    }else{
      alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF");
    }
  })
  .catch(()=>{
    loader.style.display="none";
    submitBtn.disabled = false;
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
  });
}
</script>

</body>
</html>
